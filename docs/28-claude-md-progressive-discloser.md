# CLAUDE.md Progressive Discloser Optimizer - CLAUDE.md渐进式披露优化器

## 简介

CLAUDE.md Progressive Discloser Optimizer skill用于通过应用渐进式披露原则来分析和优化用户CLAUDE.md文件，以减少上下文开销同时保留功能性。

## 快速开始

1. **备份** 原始文件先
2. **审计** 当前状态（列出所有部分及行数）
3. **分类** 每个部分使用以下标准
4. **提出** 带有前后比较表的优化
5. **验证** 在执行前信息完整性检查表
6. **执行** 批准的更改
7. **测试** 移动的内容仍然可发现

## 部分分类

分析每个部分并分类：

| 类别 | 标准 | 操作 |
|------|--------|--------|
| **保留在CLAUDE.md中** | 核心原则、短规则（<10行）、频繁需要 | 原样保留 |
| **移动到references/** | 详细程序、代码示例、故障排除指南 | 创建`~/.claude/references/<name>.md` |
| **提取到skill** | 可重用的工作流、脚本、领域特定知识 | 在skills仓库中创建skill |
| **删除** | 重复现有skills、过时或不必要 | 确认后删除 |

### 大小指南的例外

即使部分>50行，**保留在CLAUDE.md中**如果以下任何适用：

| 例外 | 原因 | 示例 |
|-----------|--------|---------|
| **安全关键** | 忘记的后果严重 | 部署协议、"从不强制推送到main" |
| **高频** | 在大多数对话中引用 | 核心开发模式、常见命令 |
| **容易违反** | Claude在不可见时倾向于忽略 | 代码风格规则、权限要求 |
| **安全敏感** | 必须始终强制执行 | 生产访问限制、数据处理规则 |

**经验法则：** 如果忘记规则可能导致生产事故、数据丢失或安全漏洞，无论长度如何都要保持可见。

## 优化工作流

### 步骤0：备份原始文件

**关键：** 在任何更改之前始终创建备份。

```bash
# 创建时间戳备份
cp ~/.claude/CLAUDE.md ~/.claude/CLAUDE.md.bak.$(date +%Y%m%d_%H%M%S)

# 对于项目级CLAUDE.md
cp CLAUDE.md CLAUDE.md.bak.$(date +%Y%m%d_%H%M%S)
```

如果优化后发现问题：
```bash
# 从备份恢复
cp ~/.claude/CLAUDE.md.bak.YYYYMMDD_HHMMSS ~/.claude/CLAUDE.md
```

### 步骤1：审计当前状态

```
任务进度：
- [ ] 创建备份（步骤0）
- [ ] 阅读~/.claude/CLAUDE.md
- [ ] 计算总行数
- [ ] 列出所有##部分及行数
- [ ] 识别>20行的部分
```

### 步骤2：分类每个部分

对于每个>20行的部分，确定：

1. **频率：** 此信息多久需要一次？
2. **复杂性：** 它是否包含代码块、表格或详细步骤？
3. **可重用性：** 其他用户可以将其作为skill受益吗？

### 步骤3：提出更改

以这种格式提出优化计划：

```markdown
## 优化提案

**当前：** X行
**之后：** Y行（Z%减少）

| 部分 | 行数 | 操作 | 目的地 |
|---------|-------|--------|-------------|
| 部分A | 50 | 移动到references | ~/.claude/references/section_a.md |
| 部分B | 80 | 提取到skill | skill-name/ |
| 部分C | 5 | 保留 | - |
```

### 步骤3.5：执行前验证检查表

**关键：** 在执行任何更改之前，验证信息完整性。

对于每个移动或修改的部分：

1. **提取关键项目**以验证：
   - 凭据/密码/API密钥
   - 关键规则（"从不做X"、"总是做Y"）
   - 特定值（端口、IP、URL、路径）
   - 频繁引用的代码片段
   - 对其他部分的交叉引用

2. **创建验证检查表：**
   ```markdown
   ## [部分名称]的验证检查表

   | 关键项目 | 原始位置 | 新位置 | 已验证 |
   |----------|-----------|----------|----------|
   | 服务器IP 47.96.x.x | 第123行 | infrastructure.md:15 | [ ] |
   | "从不推送到main"规则 | 第45行 | 保留在CLAUDE.md | [ ] |
   | 登录凭据 | 第200行 | api-login.md:30 | [ ] |
   ```

3. **检查交叉引用：**
   - 如果部分A引用部分B，确保移动后链接工作
   - 如需要，将相对路径更新为绝对路径

### 步骤4：执行更改

用户批准且验证检查表完成后：

1. 在`~/.claude/references/`中创建引用文件
2. 用指向移动内容的指针更新CLAUDE.md
3. 如适用，创建skills
4. **验证每个检查表项存在于新位置**
5. 报告最终行数

### 步骤5：优化后测试

验证Claude仍然可以发现移动的内容：

1. **测试可发现性** - 询问需要移动内容的问题：
   ```
   要运行的测试查询：
   - "我如何连接到生产数据库？"
   - "[服务]的部署步骤是什么？"
   - "显示[系统]的凭据"
   ```

2. **验证指针功能** - 每个"See `reference.md`"链接应该工作：
   ```bash
   # 检查所有引用的文件存在
   grep -oh '`~/.claude/references/[^`]*`' ~/.claude/CLAUDE.md | \
     sed 's/`//g' | while read f; do
       eval test -f "$f" && echo "✓ $f" || echo "✗ MISSING: $f"
     done
   ```

3. **与备份比较** - 确保无意外删除：
   ```bash
   diff ~/.claude/CLAUDE.md.bak.* ~/.claude/CLAUDE.md | grep "^<" | head -20
   ```

4. **记录结果：**
   ```markdown
   ## 优化结果

   | 指标 | 之前 | 之后 |
   |--------|-------|-------|
   | 总行数 | X | Y |
   | 减少 | - | Z% |
   | 创建的引用 | - | N个文件 |
   | 提取的skills | - | M个skills |

   **验证：** 所有N个检查表项已验证 ✓
   **测试：** 所有K个测试查询返回正确信息 ✓
   ```

## 引用文件格式

将内容移动到`~/.claude/references/`时：

```markdown
# [部分标题]

[完整的原始内容，可能用额外示例增强]
```

## CLAUDE.md指针格式

用以下内容替换移动的部分：

```markdown
## [部分标题]

[一行摘要]。See `~/.claude/references/[filename].md`
```

## 最佳实践

- **保持核心原则可见：** 像"从不做X"这样的规则应该保留在CLAUDE.md中
- **组合相关引用：** 将小的相关部分组合到一个引用文件中
- **保留快速命令：** 在CLAUDE.md中保留频繁使用的命令片段
- **优化后测试：** 确保Claude仍然可以找到移动的信息

## 常见模式

### 模式：基础设施/凭据
**之前：** 完整的API示例、部署脚本、服务器列表
**之后：** 指向`~/.claude/references/infrastructure.md`的一行指针

### 模式：代码生成规则
**之前：** 50+行带有示例的编码标准
**之后：** 保留要点规则，将示例移动到references

### 模式：可重用的工作流
**之前：** 完整脚本嵌入在CLAUDE.md中
**之后：** 提取到带有scripts/目录的skill

## 项目级 vs 用户级CLAUDE.md

此skill处理两种类型，但策略不同：

### 用户级（`~/.claude/CLAUDE.md`）

| 方面 | 方法 |
|--------|--------|
| **引用位置** | `~/.claude/references/` |
| **范围** | 个人偏好、全局规则 |
| **共享** | 不共享，仅个人 |
| **大小目标** | 100-200行理想 |

### 项目级（`/path/to/project/CLAUDE.md`）

| 方面 | 方法 |
|--------|--------|
| **引用位置** | `docs/`或项目根目录中的`.claude/` |
| **范围** | 项目特定模式、架构 |
| **共享** | 提交到git，与团队共享 |
| **大小目标** | 300-600行可接受（需要更多项目上下文） |

### 关键差异

1. **引用路径：** 项目级使用相对路径（`docs/best-practices/`）
2. **Git考虑：** 项目引用随代码版本化
3. **团队对齐：** 项目CLAUDE.md应该反映团队共识
4. **更新频率：** 项目级随着代码演进更频繁地更改

### 项目级指针格式

```markdown
## [部分标题]

[摘要]。See `docs/06-best-practices/[topic].md`
```

**注意：** 对于项目CLAUDE.md，优先使用`docs/`而不是隐藏目录，以便人类团队成员可以发现。
