{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- å·¦ä¾§ï¼šè¾“å…¥å’Œç»Ÿè®¡ -->
        <div class="col-lg-4">
            <!-- æ–¹æ¡ˆåˆ—è¡¨å¡ç‰‡ -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-collection"></i> æ–¹æ¡ˆåˆ—è¡¨</h5>
                </div>
                <div class="card-body">
                    <div id="plan-list">
                        <p class="text-muted text-center small">åŠ è½½ä¸­...</p>
                    </div>
                    <button class="btn btn-primary w-100 mt-2" onclick="openCompareModal()">
                        <i class="bi bi-bar-chart"></i> å¯¹æ¯”æ–¹æ¡ˆ
                    </button>
                </div>
            </div>

            <!-- è€ƒç”Ÿä¿¡æ¯å¡ç‰‡ -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person"></i> è€ƒç”Ÿä¿¡æ¯</h5>
                </div>
                <div class="card-body">
                    <div>
                        <div class="mb-3">
                            <label class="form-label">é«˜è€ƒåˆ†æ•°</label>
                            <input type="number" class="form-control" id="student-score" 
                                   placeholder="è¾“å…¥é«˜è€ƒåˆ†æ•°" min="300" max="750">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ä½æ¬¡</label>
                            <input type="number" class="form-control" id="student-rank" 
                                   placeholder="è¾“å…¥ä½æ¬¡" min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ–‡ç†ç§‘</label>
                            <select class="form-select" id="subject-type">
                                <option value="ç†ç§‘">ç†ç§‘</option>
                                <option value="æ–‡ç§‘">æ–‡ç§‘</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ–¹æ¡ˆç»Ÿè®¡å¡ç‰‡ -->
            <div class="card mb-4" id="statistics-card" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> æ–¹æ¡ˆç»Ÿè®¡</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4 mb-3">
                            <div class="p-3 bg-light rounded">
                                <h6 class="mb-1 text-muted">æ€»å¿—æ„¿</h6>
                                <div class="h4 mb-0" id="total-count">0</div>
                            </div>
                        </div>
                        <div class="col-4 mb-3">
                            <div class="p-3 bg-danger bg-opacity-10 rounded">
                                <h6 class="mb-1 text-muted">å†²</h6>
                                <div class="h4 mb-0" id="å†²-count">0</div>
                            </div>
                        </div>
                        <div class="col-4 mb-3">
                            <div class="p-3 bg-warning bg-opacity-10 rounded">
                                <h6 class="mb-1 text-muted">ç¨³</h6>
                                <div class="h4 mb-0" id="ç¨³-count">0</div>
                            </div>
                        </div>
                        <div class="col-4 mb-3">
                            <div class="p-3 bg-success bg-opacity-10 rounded">
                                <h6 class="mb-1 text-muted">ä¿</h6>
                                <div class="h4 mb-0" id="ä¿-count">0</div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <h6 class="mb-2">å¹³å‡å½•å–æ¦‚ç‡</h6>
                        <div class="h3" id="avg-probability">0%</div>
                    </div>
                </div>
            </div>

            <!-- é£é™©è¯„ä¼°å¡ç‰‡ -->
            <div class="card mb-4" id="risk-assessment-card" style="display: none;">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="bi bi-shield-exclamation"></i> é£é™©è¯„ä¼°</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">æ€»ä½“é£é™©ç­‰çº§</h6>
                            <span class="badge" id="overall-risk-badge">ä½</span>
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h6 class="mb-2"><i class="bi bi-lightbulb"></i> ä¼˜åŒ–å»ºè®®</h6>
                        <div id="risk-suggestions">
                            <p class="text-muted small">æ·»åŠ å¿—æ„¿åå¯æŸ¥çœ‹é£é™©è¯„ä¼°å’Œå»ºè®®</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ–¹æ¡ˆæ“ä½œå¡ç‰‡ -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> æ–¹æ¡ˆç®¡ç†</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="createNewPlan()">
                        <i class="bi bi-plus"></i> æ–°å»ºæ–¹æ¡ˆ
                    </button>
                    <button class="btn btn-outline-success w-100 mb-2" onclick="exportPlan('excel')">
                        <i class="bi bi-file-earmark-excel"></i> å¯¼å‡ºExcel
                    </button>
                    <button class="btn btn-outline-info w-100 mb-2" onclick="exportPlan('pdf')">
                        <i class="bi bi-file-earmark-pdf"></i> å¯¼å‡ºPDF
                    </button>
                    <button class="btn btn-outline-danger w-100" onclick="clearPlan()">
                        <i class="bi bi-trash"></i> æ¸…ç©ºå¿—æ„¿
                    </button>
                </div>
            </div>

            <!-- å¯è§†åŒ–åˆ†æå¡ç‰‡ -->
            <div class="card mb-4" id="visualization-card" style="display: none;">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> æ•°æ®å¯è§†åŒ–</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="mb-2">å½•å–æ¦‚ç‡åˆ†å¸ƒ</h6>
                        <canvas id="probability-chart" height="200"></canvas>
                    </div>
                    <div class="mb-3">
                        <h6 class="mb-2">é£é™©ç­‰çº§åˆ†å¸ƒ</h6>
                        <canvas id="risk-chart" height="200"></canvas>
                    </div>
                    <div class="mb-3">
                        <h6 class="mb-2">åœ°åŸŸåˆ†å¸ƒ</h6>
                        <canvas id="location-chart" height="200"></canvas>
                    </div>
                    <div class="mb-3">
                        <h6 class="mb-2">å­¦æ ¡å±‚æ¬¡åˆ†å¸ƒ</h6>
                        <canvas id="school-type-chart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- æ™ºèƒ½æ¨èå¡ç‰‡ -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-magic"></i> æ™ºèƒ½æ¨è</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">åœ°åŒºåå¥½</label>
                        <select class="form-select" id="pref-locations" multiple style="height: 100px;">
                            <option value="åŒ—äº¬">åŒ—äº¬</option>
                            <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                            <option value="è¾½å®">è¾½å®</option>
                            <option value="æ±Ÿè‹">æ±Ÿè‹</option>
                            <option value="æµ™æ±Ÿ">æµ™æ±Ÿ</option>
                            <option value="å¹¿ä¸œ">å¹¿ä¸œ</option>
                            <option value="æ¹–åŒ—">æ¹–åŒ—</option>
                            <option value="å››å·">å››å·</option>
                            <option value="é™•è¥¿">é™•è¥¿</option>
                        </select>
                        <small class="text-muted">æŒ‰ä½Ctrlå¯å¤šé€‰</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä¸“ä¸šåå¥½</label>
                        <select class="form-select" id="pref-majors" multiple style="height: 100px;">
                            <option value="è®¡ç®—æœº">è®¡ç®—æœº</option>
                            <option value="äººå·¥æ™ºèƒ½">äººå·¥æ™ºèƒ½</option>
                            <option value="ç”µå­ä¿¡æ¯">ç”µå­ä¿¡æ¯</option>
                            <option value="ç»æµå­¦">ç»æµå­¦</option>
                            <option value="é‡‘èå­¦">é‡‘èå­¦</option>
                            <option value="æœºæ¢°å·¥ç¨‹">æœºæ¢°å·¥ç¨‹</option>
                            <option value="è‡ªåŠ¨åŒ–">è‡ªåŠ¨åŒ–</option>
                        </select>
                        <small class="text-muted">æŒ‰ä½Ctrlå¯å¤šé€‰</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å­¦æ ¡ç±»å‹</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="pref-985" value="985" checked>
                            <label class="form-check-label" for="pref-985">985é™¢æ ¡</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="pref-211" value="211" checked>
                            <label class="form-check-label" for="pref-211">211é™¢æ ¡</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="pref-double-first" value="åŒä¸€æµ" checked>
                            <label class="form-check-label" for="pref-double-first">åŒä¸€æµ</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ¢¯åº¦é…ç½®</label>
                        <div class="row">
                            <div class="col-4">
                                <label class="small text-muted">å†²</label>
                                <input type="number" class="form-control" id="pref-chong" value="20" min="0" max="120">
                            </div>
                            <div class="col-4">
                                <label class="small text-muted">ç¨³</label>
                                <input type="number" class="form-control" id="pref-wen" value="60" min="0" max="120">
                            </div>
                            <div class="col-4">
                                <label class="small text-muted">ä¿</label>
                                <input type="number" class="form-control" id="pref-bao" value="40" min="0" max="120">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æœ€ä½å½•å–æ¦‚ç‡</label>
                        <input type="number" class="form-control" id="pref-min-prob" value="30" min="0" max="100" placeholder="0-100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ¨èç®—æ³•</label>
                        <select class="form-select" id="algorithm-select">
                            <option value="weighted" selected>å¤šå› ç´ åŠ æƒè¯„åˆ†ï¼ˆæ¨èï¼‰</option>
                            <option value="ml">æœºå™¨å­¦ä¹ é¢„æµ‹</option>
                        </select>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> 
                            <span id="algorithm-description">ç»¼åˆè€ƒè™‘ä½æ¬¡ã€åˆ†æ•°ã€å­¦æ ¡å±‚æ¬¡ã€ä¸“ä¸šåŒ¹é…ç­‰å¤šä¸ªå› ç´ </span>
                        </small>
                    </div>
                    <button class="btn btn-success w-100" onclick="generateVolunteers()">
                        <i class="bi bi-magic"></i> ä¸€é”®ç”Ÿæˆ120ä¸ªå¿—æ„¿
                    </button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå¿—æ„¿åˆ—è¡¨ -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ol"></i> 120ä¸ªå¹³è¡Œå¿—æ„¿
                        <span class="badge bg-secondary ms-2" id="progress-badge">0/120</span>
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-primary" onclick="openAddModal()">
                            <i class="bi bi-plus"></i> æ·»åŠ å¿—æ„¿
                        </button>
                        <button class="btn btn-sm btn-info" onclick="openBatchAddModal()">
                            <i class="bi bi-plus-lg"></i> æ‰¹é‡æ·»åŠ 
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="volunteer-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">æ‹–æ‹½</th>
                                    <th style="width: 80px;">åºå·</th>
                                    <th style="width: 200px;">å­¦æ ¡</th>
                                    <th style="width: 200px;">ä¸“ä¸š</th>
                                    <th style="width: 100px;">2025ä½æ¬¡</th>
                                    <th style="width: 100px;">æ¦‚ç‡</th>
                                    <th style="width: 80px;">é£é™©</th>
                                    <th style="width: 80px;">ç±»åˆ«</th>
                                    <th style="width: 200px;">ç±»åˆ«ä¾æ®</th>
                                    <th style="width: 100px;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="volunteer-tbody">
                                <tr>
                                    <td colspan="10" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox fs-1"></i>
                                        <p class="mb-0 mt-2">è¯·å…ˆè¾“å…¥è€ƒç”Ÿä¿¡æ¯ï¼Œç„¶åæ·»åŠ å¿—æ„¿</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ å¿—æ„¿æ¨¡æ€æ¡† -->
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ·»åŠ å¿—æ„¿</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-volunteer-form">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©å­¦æ ¡</label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="school-search" 
                                   placeholder="è¾“å…¥å­¦æ ¡åç§°æˆ–ä»£ç " autocomplete="off">
                            <div id="school-suggestions" class="dropdown-menu w-100 shadow-sm" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©ä¸“ä¸š</label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="major-search" 
                                   placeholder="è¯·å…ˆé€‰æ‹©å­¦æ ¡ï¼Œç„¶åè¾“å…¥ä¸“ä¸šåç§°" autocomplete="off" disabled>
                            <div id="major-suggestions" class="dropdown-menu w-100 shadow-sm" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmAddVolunteer()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡æ·»åŠ æ¨¡æ€æ¡† -->
<div class="modal fade" id="batchAddModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ‰¹é‡æ·»åŠ å­¦æ ¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©å­¦æ ¡ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div class="mb-2">
                        <input type="text" class="form-control" id="batch-school-search" 
                               placeholder="æœç´¢å­¦æ ¡..." autocomplete="off">
                    </div>
                    <div id="batch-school-list" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                        <p class="text-muted text-center">è¯·è¾“å…¥å­¦æ ¡åç§°è¿›è¡Œæœç´¢</p>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">ä¸“ä¸šåç§°</label>
                    <input type="text" class="form-control" id="batch-major-name" 
                           placeholder="è¾“å…¥ä¸“ä¸šåç§°ï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤ä¸“ä¸šï¼‰">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmBatchAdd()">æ‰¹é‡æ·»åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- æ–¹æ¡ˆå¯¹æ¯”æ¨¡æ€æ¡† -->
<div class="modal fade" id="compareModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ–¹æ¡ˆå¯¹æ¯”</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©æ–¹æ¡ˆè¿›è¡Œå¯¹æ¯”ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div id="compare-plan-list" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                        <p class="text-muted text-center">åŠ è½½ä¸­...</p>
                    </div>
                </div>
                <div id="comparison-result" style="display: none;">
                    <h6 class="mb-3">å¯¹æ¯”ç»“æœ</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="comparison-table">
                            <thead class="table-light">
                                <tr id="comparison-header">
                                    <th>æŒ‡æ ‡</th>
                                </tr>
                            </thead>
                            <tbody id="comparison-body">
                            </tbody>
                        </table>
                    </div>
                    <div id="best-plan-badge" class="mt-3"></div>
                    <div class="mt-3">
                        <h6>ä¼˜åŒ–å»ºè®®</h6>
                        <div id="comparison-suggestions"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="confirmCompare()">å¼€å§‹å¯¹æ¯”</button>
                <button type="button" class="btn btn-success" onclick="exportComparison()" id="export-compare-btn" style="display: none;">
                    <i class="bi bi-download"></i> å¯¼å‡ºå¯¹æ¯”æŠ¥å‘Š
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// å…¨å±€å˜é‡
let selectedSchoolCode = '';
let selectedSchoolName = '';
let selectedBatchSchools = new Set();

// ç®—æ³•é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°æè¿°ï¼ˆç»Ÿä¸€å¤„ç†ï¼Œé¿å…é‡å¤ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    const algorithmSelect = document.getElementById('algorithm-select');
    const descriptionSpan = document.getElementById('algorithm-description');
    
    // ç®—æ³•æè¿°
    const descriptions = {
        'weighted': 'ç»¼åˆè€ƒè™‘ä½æ¬¡ã€åˆ†æ•°ã€å­¦æ ¡å±‚æ¬¡ã€ä¸“ä¸šåŒ¹é…ç­‰å¤šä¸ªå› ç´ ï¼Œè®¡ç®—ç»¼åˆå¾—åˆ†è¿›è¡Œæ¨è',
        'ml': 'åŸºäºæœºå™¨å­¦ä¹ æ¨¡å‹é¢„æµ‹å½•å–æ¦‚ç‡ï¼Œè‡ªåŠ¨å­¦ä¹ å†å²æ•°æ®ä¸­çš„å¤æ‚æ¨¡å¼ï¼Œæ¨èæ›´ç²¾å‡†'
    };
    
    // åˆå§‹åŒ–æ˜¾ç¤º
    descriptionSpan.textContent = descriptions[algorithmSelect.value];
    
    // ç›‘å¬å˜åŒ–
    algorithmSelect.addEventListener('change', function() {
        descriptionSpan.textContent = descriptions[this.value];
    });
});

// åŠ è½½å¿—æ„¿åˆ—è¡¨
async function loadVolunteers() {
    try {
        const response = await fetch('/api/volunteer/volunteers');
        const result = await response.json();

        if (result.success) {
            displayVolunteers(result.data);
            updateStatistics();
        }
    } catch (error) {
        console.error('åŠ è½½å¿—æ„¿å¤±è´¥ï¼š', error);
    }
}

// æ˜¾ç¤ºå¿—æ„¿åˆ—è¡¨
function displayVolunteers(volunteers) {
    const tbody = document.getElementById('volunteer-tbody');

    if (!volunteers || volunteers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1"></i>
                    <p class="mb-0 mt-2">æš‚æ— å¿—æ„¿ï¼Œç‚¹å‡»"æ·»åŠ å¿—æ„¿"å¼€å§‹å¡«æŠ¥</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = volunteers.map(v => {
        // ç”Ÿæˆå­¦æ ¡æ ‡ç­¾HTML
        let tagsHtml = '';
        if (v.tags) {
            if (v.tags.is_985) tagsHtml += '<span class="badge bg-danger me-1">985</span>';
            if (v.tags.is_211) tagsHtml += '<span class="badge bg-warning me-1">211</span>';
        }
        
        // ç”Ÿæˆé™¢æ ¡é“¾æ¥
        const schoolLink = `<a href="javascript:void(0)" onclick="openUniversityAnalysis('${v.school_name}', '${v.major_name}', '${v.avg_rank_2025 || ''}', event)">${v.school_name}</a>`;
        
        return `
        <tr draggable="true" data-volunteer-id="${v.id}" class="volunteer-row">
            <td class="drag-handle">
                <i class="bi bi-grip-vertical text-muted" style="cursor: move;"></i>
            </td>
            <td><strong>${v.id}</strong></td>
            <td>${schoolLink} ${tagsHtml}</td>
            <td>${v.major_name}</td>
            <td>${v.avg_rank_2025 || '-'}</td>
            <td>
                <span class="badge ${getProbabilityBadgeClass(v.admission_probability)}">
                    ${v.admission_probability ? v.admission_probability.toFixed(1) + '%' : '-'}
                </span>
            </td>
            <td>
                <span class="badge ${getRiskBadgeClass(v.risk_level)}">
                    ${v.risk_level || '-'}
                </span>
            </td>
            <td>
                <span class="badge ${getCategoryBadgeClass(v.category)}">
                    ${v.category || '-'}
                </span>
            </td>
            <td>
                <small class="text-muted">${v.category_basis || '-'}</small>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteVolunteer('${v.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
        `;
    }).join('');

    // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
    initDragAndDrop();

    document.getElementById('progress-badge').textContent = `${volunteers.length}/120`;
}

// åˆå§‹åŒ–æ‹–æ‹½æ’åº
function initDragAndDrop() {
    const tbody = document.getElementById('volunteer-tbody');
    const rows = tbody.querySelectorAll('.volunteer-row');

    rows.forEach(row => {
        row.addEventListener('dragstart', handleDragStart);
        row.addEventListener('dragend', handleDragEnd);
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('drop', handleDrop);
    });
}

let draggedRow = null;

function handleDragStart(e) {
    draggedRow = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.volunteer-row').forEach(row => {
        row.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    e.preventDefault();
    if (this !== draggedRow) {
        this.classList.add('drag-over');
    }
}

function handleDrop(e) {
    e.preventDefault();
    if (this === draggedRow) return;

    this.classList.remove('drag-over');

    // è·å–å½“å‰æ‰€æœ‰å¿—æ„¿ID
    const tbody = document.getElementById('volunteer-tbody');
    const rows = Array.from(tbody.querySelectorAll('.volunteer-row'));
    const newOrder = rows.map(row => parseInt(row.dataset.volunteerId));

    // å‘é€æ–°é¡ºåºåˆ°åç«¯
    fetch('/api/volunteer/volunteers/reorder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order: newOrder })
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            loadVolunteers();
        }
    })
    .catch(error => {
        console.error('æ’åºå¤±è´¥ï¼š', error);
    });
}

// æ›´æ–°ç»Ÿè®¡
function updateStatistics() {
    try {
        fetch('/api/volunteer/plan/current')
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    const stats = result.data.statistics;
                    document.getElementById('total-count').textContent = stats.total;
                    document.getElementById('å†²-count').textContent = stats.å†²;
                    document.getElementById('ç¨³-count').textContent = stats.ç¨³;
                    document.getElementById('ä¿-count').textContent = stats.ä¿;
                    document.getElementById('avg-probability').textContent = stats.avg_probability + '%';
                    document.getElementById('statistics-card').style.display = 'block';

                    // åŒæ—¶åŠ è½½é£é™©è¯„ä¼°
                    updateRiskAssessment();

                    // åŠ è½½å¯è§†åŒ–æ•°æ®
                    loadVisualizationData();

                    // åŠ è½½æ–¹æ¡ˆåˆ—è¡¨
                    loadPlanList();
                }
            });
    } catch (error) {
        console.error('è·å–ç»Ÿè®¡å¤±è´¥ï¼š', error);
    }
}

// åŠ è½½å¯è§†åŒ–æ•°æ®
async function loadVisualizationData() {
    try {
        const response = await fetch('/api/volunteer/analysis/visualization');
        const result = await response.json();

        if (result.success && result.data) {
            document.getElementById('visualization-card').style.display = 'block';
            renderCharts(result.data);
        } else {
            // æ²¡æœ‰æ•°æ®æ—¶éšè—å¯è§†åŒ–å¡ç‰‡
            document.getElementById('visualization-card').style.display = 'none';
        }
    } catch (error) {
        console.error('åŠ è½½å¯è§†åŒ–æ•°æ®å¤±è´¥ï¼š', error);
        // å‡ºé”™æ—¶éšè—å¯è§†åŒ–å¡ç‰‡
        document.getElementById('visualization-card').style.display = 'none';
    }
}

// æ¸²æŸ“å›¾è¡¨
function renderCharts(data) {
    // 1. å½•å–æ¦‚ç‡åˆ†å¸ƒï¼ˆæŸ±çŠ¶å›¾ï¼‰
    renderBarChart(
        'probability-chart',
        Object.keys(data.probability_distribution),
        Object.values(data.probability_distribution),
        'å½•å–æ¦‚ç‡åˆ†å¸ƒ',
        ['#dc3545', '#fd7e14', '#ffc107', '#20c997', '#0d6efd']
    );

    // 2. é£é™©ç­‰çº§åˆ†å¸ƒï¼ˆé¥¼å›¾ï¼‰
    renderPieChart(
        'risk-chart',
        Object.keys(data.risk_distribution),
        Object.values(data.risk_distribution),
        'é£é™©ç­‰çº§åˆ†å¸ƒ'
    );

    // 3. åœ°åŸŸåˆ†å¸ƒï¼ˆé¥¼å›¾ï¼‰
    renderPieChart(
        'location-chart',
        Object.keys(data.location_distribution),
        Object.values(data.location_distribution),
        'åœ°åŸŸåˆ†å¸ƒ'
    );

    // 4. å­¦æ ¡å±‚æ¬¡åˆ†å¸ƒï¼ˆæŸ±çŠ¶å›¾ï¼‰
    renderBarChart(
        'school-type-chart',
        Object.keys(data.school_type_distribution),
        Object.values(data.school_type_distribution),
        'å­¦æ ¡å±‚æ¬¡åˆ†å¸ƒ',
        ['#dc3545', '#fd7e14', '#0dcaf0', '#6c757d']
    );
}

// æ¸²æŸ“æŸ±çŠ¶å›¾ï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨çº¯HTML/CSSï¼‰
function renderBarChart(canvasId, labels, values, title, colors) {
    try {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        const maxValue = Math.max(...values) || 1;

        // ç®€å•çš„æŸ±çŠ¶å›¾å®ç°
        let html = `<h6>${title}</h6><div class="d-flex align-items-end justify-content-around" style="height: 200px;">`;
        labels.forEach((label, index) => {
            const height = (values[index] / maxValue) * 180;
            const color = colors[index % colors.length];
            html += `
                <div class="text-center mx-1" style="width: 50px;">
                    <div class="bg-primary rounded" style="background-color: ${color}; height: ${height}px; min-height: 10px;"></div>
                    <div class="small mt-1">${values[index]}</div>
                    <div class="small text-muted" style="font-size: 10px;">${label}</div>
                </div>
            `;
        });


        html += '</div>';

        const parent = canvas.parentElement;
        if (parent) {
            parent.innerHTML = html;
        }
    } catch (error) {
        console.error('æ¸²æŸ“æŸ±çŠ¶å›¾å¤±è´¥ï¼š', error);
    }
}

// æ¸²æŸ“é¥¼å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰
function renderPieChart(canvasId, labels, values, title) {
    try {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        const total = values.reduce((a, b) => a + b, 0) || 1;
        const colors = ['#0d6efd', '#dc3545', '#198754', '#ffc107', '#0dcaf0', '#6c757d'];

        let html = `<h6>${title}</h6><div class="d-flex flex-wrap">`;
        labels.forEach((label, index) => {
            const percentage = ((values[index] / total) * 100).toFixed(1);
            const color = colors[index % colors.length];
            html += `
                <div class="d-flex align-items-center me-3 mb-2">
                    <span class="badge me-2" style="background-color: ${color};">&nbsp;</span>
                    <small>${label} (${values[index]})</small>
                </div>
            `;
        });


        html += '</div>';

        const parent = canvas.parentElement;
        if (parent) {
            parent.innerHTML = html;
        }
    } catch (error) {
        console.error('æ¸²æŸ“é¥¼å›¾å¤±è´¥ï¼š', error);
    }
}

// åŠ è½½æ–¹æ¡ˆåˆ—è¡¨
async function loadPlanList() {
    try {
        const response = await fetch('/api/volunteer/plans');
        const result = await response.json();

        if (result.success && result.data.length > 0) {
            const planListDiv = document.getElementById('plan-list');
            planListDiv.innerHTML = result.data.map(plan => `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div>
                        <strong>${plan.name}</strong>
                        <span class="badge bg-primary ms-2">${plan.statistics.total}ä¸ªå¿—æ„¿</span>
                        <br>
                        <small class="text-muted">${plan.created_at}</small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="loadPlan('${plan.id}')">åŠ è½½</button>
                        <button class="btn btn-outline-danger" onclick="deletePlan('${plan.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        } else {
            document.getElementById('plan-list').innerHTML = '<p class="text-muted text-center small">æš‚æ— æ–¹æ¡ˆ</p>';
        }
    } catch (error) {
        console.error('åŠ è½½æ–¹æ¡ˆåˆ—è¡¨å¤±è´¥ï¼š', error);
    }
}

// åŠ è½½æŒ‡å®šæ–¹æ¡ˆ
async function loadPlan(planId) {
    try {
        const response = await fetch(`/api/volunteer/plan/${planId}`);
        const result = await response.json();

        if (result.success) {
            const plan = result.data;
            
            // æ›´æ–°è€ƒç”Ÿä¿¡æ¯è¡¨å•
            if (plan.student_info) {
                // æå–å­¦ç”Ÿä¿¡æ¯ï¼ˆä»å­—ç¬¦ä¸²ä¸­è§£æï¼‰
                const infoStr = plan.student_info;
                const scoreMatch = infoStr.match(/åˆ†æ•°:(\d+)/);
                const rankMatch = infoStr.match(/ä½æ¬¡:(\d+)/);
                const subjectTypeMatch = infoStr.match(/(æ–‡|ç†)ç§‘/);
                
                if (scoreMatch) document.getElementById('student-score').value = scoreMatch[1];
                if (rankMatch) document.getElementById('student-rank').value = rankMatch[1];
                if (subjectTypeMatch) {
                    document.getElementById('subject-type').value = subjectTypeMatch[0];
                }
            }
            
            // åŠ è½½å¿—æ„¿åˆ—è¡¨
            loadVolunteers();
            
            // åˆ·æ–°æ–¹æ¡ˆåˆ—è¡¨
            loadPlanList();
            
            alert('æ–¹æ¡ˆåŠ è½½æˆåŠŸï¼');
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('åŠ è½½å¤±è´¥ï¼š' + error.message);
    }
}

// åˆ é™¤æ–¹æ¡ˆ
async function deletePlan(planId) {
    if (!confirm('ç¡®è®¤åˆ é™¤æ­¤æ–¹æ¡ˆï¼Ÿ')) return;

    try {
        const response = await fetch(`/api/volunteer/plan/${planId}`, {
            method: 'DELETE'
        });



        const result = await response.json();
        if (result.success) {
            alert('åˆ é™¤æˆåŠŸï¼');
            loadPlanList();
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
    }
}

// åˆ›å»ºæ–°æ–¹æ¡ˆ
function createNewPlan() {
    const name = prompt('è¯·è¾“å…¥æ–¹æ¡ˆåç§°ï¼š', 'æ–°æ–¹æ¡ˆ');
    if (!name) return;

    const score = prompt('è¯·è¾“å…¥é«˜è€ƒåˆ†æ•°ï¼š', '600');
    const rank = prompt('è¯·è¾“å…¥ä½æ¬¡ï¼š', '5000');

    if (!score || !rank) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
    }

    const data = {
        name: name,
        score: parseInt(score),
        rank: parseInt(rank),
        subject_type: 'ç†ç§‘'
    };

    fetch('/api/volunteer/plan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            alert('æ–¹æ¡ˆåˆ›å»ºæˆåŠŸï¼');
            loadVolunteers();
            loadPlanList();
        } else {
            alert(result.message);
        }
    })
    .catch(error => {
        alert('åˆ›å»ºå¤±è´¥ï¼š' + error.message);
    });


}

// æ‰“å¼€å¯¹æ¯”æ¨¡æ€æ¡†
async function openCompareModal() {
    const modal = new bootstrap.Modal(document.getElementById('compareModal'));
    modal.show();

    // åŠ è½½æ–¹æ¡ˆåˆ—è¡¨ç”¨äºå¯¹æ¯”
    try {
        const response = await fetch('/api/volunteer/plans');
        const result = await response.json();

        if (result.success && result.data.length > 0) {
            const compareListDiv = document.getElementById('compare-plan-list');
            compareListDiv.innerHTML = result.data.map(plan => `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="compare-plan-${plan.id}" value="${plan.id}">
                    <label class="form-check-label" for="compare-plan-${plan.id}">
                        <strong>${plan.name}</strong>
                        <small class="text-muted ms-2">${plan.created_at}</small>
                        <small class="text-muted ms-2">å¿—æ„¿æ•°: ${plan.statistics.total}</small>
                    </label>
                </div>
            `).join('');
        } else {
            document.getElementById('compare-plan-list').innerHTML = '<p class="text-muted text-center">æš‚æ— æ–¹æ¡ˆå¯å¯¹æ¯”</p>';
        }
    } catch (error) {
        console.error('åŠ è½½æ–¹æ¡ˆå¤±è´¥ï¼š', error);
    }

    // é‡ç½®å¯¹æ¯”ç»“æœ
    document.getElementById('comparison-result').style.display = 'none';
    document.getElementById('export-compare-btn').style.display = 'none';
}

// ç¡®è®¤å¯¹æ¯”
async function confirmCompare() {
    const checkboxes = document.querySelectorAll('#compare-plan-list input[type="checkbox"]:checked');

    if (checkboxes.length < 2) {
        alert('è¯·è‡³å°‘é€‰æ‹©2ä¸ªæ–¹æ¡ˆè¿›è¡Œå¯¹æ¯”');
        return;
    }

    const planIds = Array.from(checkboxes).map(cb => cb.value);

    try {
        const response = await fetch('/api/volunteer/compare', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan_ids: planIds })
        });



        const result = await response.json();

        if (result.success) {
            displayComparisonResult(result.data);
            document.getElementById('export-compare-btn').style.display = 'inline-block';
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('å¯¹æ¯”å¤±è´¥ï¼š' + error.message);
    }
}

// æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
function displayComparisonResult(data) {
    // æ˜¾ç¤ºå¯¹æ¯”è¡¨æ ¼
    const headerRow = document.getElementById('comparison-header');
    const tbody = document.getElementById('comparison-body');

    headerRow.innerHTML = '<th>æŒ‡æ ‡</th>';
    data.comparison_table.plans.forEach((plan, index) => {
        headerRow.innerHTML += `<th>æ–¹æ¡ˆ${index + 1}</th>`;
    });



    tbody.innerHTML = data.comparison_table.metrics.map((metric, rowIndex) => `
        <tr>
            <td><strong>${metric}</strong></td>
            ${data.comparison_table.plans.map(plan => `<td>${plan[rowIndex]}</td>`).join('')}
        </tr>
    `).join('');

    // æ˜¾ç¤ºæœ€ä¼˜æ–¹æ¡ˆ
    const bestBadge = document.getElementById('best-plan-badge');
    bestBadge.innerHTML = `<div class="alert alert-success"><strong>ğŸ† æœ€ä¼˜æ–¹æ¡ˆï¼š${data.best_plan_name}</strong></div>`;

    // æ˜¾ç¤ºä¼˜åŒ–å»ºè®®
    const suggestionsDiv = document.getElementById('comparison-suggestions');
    if (data.suggestions.length === 0) {
        suggestionsDiv.innerHTML = '<div class="alert alert-info mb-0">æ‰€æœ‰æ–¹æ¡ˆé…ç½®åˆç†ï¼Œæ— éœ€ç‰¹åˆ«ä¼˜åŒ–</div>';
    } else {
        suggestionsDiv.innerHTML = data.suggestions.map(s => `
            <div class="alert alert-warning mb-2 p-2">
                ${s}
            </div>
        `).join('');
    }

    document.getElementById('comparison-result').style.display = 'block';
}

// å¯¼å‡ºå¯¹æ¯”æŠ¥å‘Š
async function exportComparison() {
    const checkboxes = document.querySelectorAll('#compare-plan-list input[type="checkbox"]:checked');
    const planIds = Array.from(checkboxes).map(cb => cb.value);

    try {
        const response = await fetch('/api/volunteer/compare/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan_ids: planIds })
        });



        const result = await response.json();
        if (result.success) {
            alert(`å¯¼å‡ºæˆåŠŸï¼\næ–‡ä»¶ä½ç½®ï¼š${result.filepath}`);
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
    }
}

// æ›´æ–°é£é™©è¯„ä¼°
function updateRiskAssessment() {
    try {
        fetch('/api/volunteer/plan/risk-assessment')
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    const assessment = result.data;

                    // æ›´æ–°æ€»ä½“é£é™©ç­‰çº§
                    const overallRiskBadge = document.getElementById('overall-risk-badge');
                    overallRiskBadge.textContent = assessment.overall_risk;
                    overallRiskBadge.className = 'badge';
                    if (assessment.overall_risk === 'ä½') {
                        overallRiskBadge.classList.add('bg-success');
                    } else if (assessment.overall_risk === 'ä¸­') {
                        overallRiskBadge.classList.add('bg-warning');
                    } else {
                        overallRiskBadge.classList.add('bg-danger');
                    }

                    // æ›´æ–°å»ºè®®
                    const suggestionsDiv = document.getElementById('risk-suggestions');
                    if (assessment.suggestions.length === 0) {
                        suggestionsDiv.innerHTML = '<p class="text-success small"><i class="bi bi-check-circle"></i> å½“å‰æ–¹æ¡ˆé…ç½®åˆç†ï¼Œæ— éœ€ç‰¹åˆ«ä¼˜åŒ–</p>';
                    } else {
                        suggestionsDiv.innerHTML = assessment.suggestions.map(s => {
                            let icon, bgClass;
                            switch(s.type) {
                                case 'success':
                                    icon = 'bi-check-circle';
                                    bgClass = 'bg-success bg-opacity-10';
                                    break;
                                case 'info':
                                    icon = 'bi-info-circle';
                                    bgClass = 'bg-info bg-opacity-10';
                                    break;
                                case 'warning':
                                    icon = 'bi-exclamation-triangle';
                                    bgClass = 'bg-warning bg-opacity-10';
                                    break;
                                case 'danger':
                                    icon = 'bi-x-circle';
                                    bgClass = 'bg-danger bg-opacity-10';
                                    break;
                                default:
                                    icon = 'bi-circle';
                                    bgClass = 'bg-light';
                            }
                            return `
                                <div class="alert ${bgClass} mb-2 p-2">
                                    <i class="bi ${icon}"></i> ${s.message}
                                </div>
                            `;
                        }).join('');
                    }

                    document.getElementById('risk-assessment-card').style.display = 'block';
                } else {
                    // æ²¡æœ‰æ•°æ®æ—¶éšè—é£é™©è¯„ä¼°å¡ç‰‡
                    document.getElementById('risk-assessment-card').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('æ›´æ–°é£é™©è¯„ä¼°å¤±è´¥ï¼š', error);
                // å‡ºé”™æ—¶éšè—é£é™©è¯„ä¼°å¡ç‰‡
                document.getElementById('risk-assessment-card').style.display = 'none';
            });


    } catch (error) {
        console.error('æ›´æ–°é£é™©è¯„ä¼°å¤±è´¥ï¼š', error);
        // å‡ºé”™æ—¶éšè—é£é™©è¯„ä¼°å¡ç‰‡
        document.getElementById('risk-assessment-card').style.display = 'none';
    }
}

// å­¦æ ¡æœç´¢å’Œè‡ªåŠ¨è¡¥å…¨
const schoolSearchInput = document.getElementById('school-search');
const schoolSuggestions = document.getElementById('school-suggestions');

let schoolSearchTimeout;
schoolSearchInput.addEventListener('input', function(e) {
    clearTimeout(schoolSearchTimeout);
    const keyword = e.target.value.trim();

    schoolSearchTimeout = setTimeout(async () => {
        if (keyword.length < 1) {
            schoolSuggestions.innerHTML = '';
            schoolSuggestions.classList.remove('show');
            return;
        }

        try {
            const response = await fetch(`/api/volunteer/search/schools?keyword=${encodeURIComponent(keyword)}`);
            const result = await response.json();

            if (result.success && result.data.length > 0) {
                schoolSuggestions.innerHTML = result.data.map(school => `
                    <a class="dropdown-item" href="#" data-code="${school.code}" data-name="${school.name}">
                        <strong>${school.name}</strong>
                        <span class="text-muted small">(${school.code})</span>
                    </a>
                `).join('');
                schoolSuggestions.classList.add('show');
            } else {
                schoolSuggestions.innerHTML = '<div class="dropdown-item text-muted">æœªæ‰¾åˆ°åŒ¹é…çš„å­¦æ ¡</div>';
                schoolSuggestions.classList.add('show');
            }
        } catch (error) {
            console.error('æœç´¢å­¦æ ¡å¤±è´¥ï¼š', error);
        }
    }, 300);
});



// é€‰æ‹©å­¦æ ¡
schoolSuggestions.addEventListener('click', function(e) {
    const item = e.target.closest('.dropdown-item');
    if (item) {
        const code = item.dataset.code;
        const name = item.dataset.name;

        schoolSearchInput.value = name;
        schoolSearchInput.dataset.code = code;
        selectedSchoolCode = code;
        selectedSchoolName = name;

        schoolSuggestions.innerHTML = '';
        schoolSuggestions.classList.remove('show');

        // å¯ç”¨ä¸“ä¸šæœç´¢å¹¶åŠ è½½è¯¥å­¦æ ¡çš„ä¸“ä¸š
        const majorSearchInput = document.getElementById('major-search');
        majorSearchInput.disabled = false;
        majorSearchInput.placeholder = 'è¾“å…¥ä¸“ä¸šåç§°è¿›è¡Œæœç´¢';
        majorSearchInput.value = '';
        majorSearchInput.focus();

        // è·å–è¯¥å­¦æ ¡çš„ä¸“ä¸š
        loadSchoolMajors(code);
    }
});



// ä¸“ä¸šæœç´¢å’Œè‡ªåŠ¨è¡¥å…¨
const majorSearchInput = document.getElementById('major-search');
const majorSuggestions = document.getElementById('major-suggestions');

let majorSearchTimeout;
majorSearchInput.addEventListener('input', function(e) {
    clearTimeout(majorSearchTimeout);
    const keyword = e.target.value.trim();

    majorSearchTimeout = setTimeout(async () => {
        if (!selectedSchoolCode) {
            majorSuggestions.innerHTML = '<div class="dropdown-item text-muted">è¯·å…ˆé€‰æ‹©å­¦æ ¡</div>';
            majorSuggestions.classList.add('show');
            return;
        }

        try {
            const response = await fetch(`/api/volunteer/school/${selectedSchoolCode}/majors/search?keyword=${encodeURIComponent(keyword)}`);
            const result = await response.json();

            if (result.success && result.data.length > 0) {
                majorSuggestions.innerHTML = result.data.slice(0, 20).map(major => `
                    <a class="dropdown-item" href="#" data-name="${major}">
                        ${major}
                    </a>
                `).join('');
                majorSuggestions.classList.add('show');
            } else {
                majorSuggestions.innerHTML = '<div class="dropdown-item text-muted">æœªæ‰¾åˆ°åŒ¹é…çš„ä¸“ä¸š</div>';
                majorSuggestions.classList.add('show');
            }
        } catch (error) {
            console.error('æœç´¢ä¸“ä¸šå¤±è´¥ï¼š', error);
        }
    }, 300);
});



// é€‰æ‹©ä¸“ä¸š
majorSuggestions.addEventListener('click', function(e) {
    const item = e.target.closest('.dropdown-item');
    if (item) {
        majorSearchInput.value = item.dataset.name;
        majorSuggestions.innerHTML = '';
        majorSuggestions.classList.remove('show');
    }
});



// åŠ è½½å­¦æ ¡ä¸“ä¸š
async function loadSchoolMajors(schoolCode) {
    try {
        const response = await fetch(`/api/volunteer/school/${schoolCode}/majors`);
        const result = await response.json();
        // ä¸“ä¸šå·²åŠ è½½ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥
    } catch (error) {
        console.error('åŠ è½½ä¸“ä¸šå¤±è´¥ï¼š', error);
    }
}

// æ·»åŠ å¿—æ„¿
async function confirmAddVolunteer() {
    const schoolName = schoolSearchInput.value;
    const schoolCode = schoolSearchInput.dataset.code;
    const majorName = majorSearchInput.value;

    if (!schoolName || !majorName) {
        alert('è¯·é€‰æ‹©å­¦æ ¡å’Œä¸“ä¸š');
        return;
    }

    // æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°120ä¸ªå¿—æ„¿ä¸Šé™
    const progressBadge = document.getElementById('progress-badge').textContent;
    const currentCount = parseInt(progressBadge.split('/')[0]);
    if (currentCount >= 120) {
        alert('å¿—æ„¿æ•°é‡å·²è¾¾åˆ°120ä¸ªä¸Šé™ï¼Œè¯·å…ˆåˆ é™¤ä¸€äº›å¿—æ„¿å†æ·»åŠ ');
        return;
    }

    const data = {
        school_code: schoolCode || '',
        school_name: schoolName,
        major_name: majorName,
        avg_rank: 0
    };

    try {
        const response = await fetch('/api/volunteer/volunteers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });



        const result = await response.json();
        if (result.success) {
            alert('æ·»åŠ æˆåŠŸï¼');
            bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
            loadVolunteers();
            // æ¸…ç©ºè¡¨å•
            schoolSearchInput.value = '';
            schoolSearchInput.dataset.code = '';
            majorSearchInput.value = '';
            majorSearchInput.disabled = true;
            majorSearchInput.placeholder = 'è¯·å…ˆé€‰æ‹©å­¦æ ¡ï¼Œç„¶åè¾“å…¥ä¸“ä¸šåç§°';
            selectedSchoolCode = '';
            selectedSchoolName = '';
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);
    }
}

// åˆ é™¤å¿—æ„¿
async function deleteVolunteer(id) {
    if (!confirm('ç¡®è®¤åˆ é™¤æ­¤å¿—æ„¿ï¼Ÿ')) return;

    try {
        const response = await fetch(`/api/volunteer/volunteer/${id}`, {
            method: 'DELETE'
        });



        const result = await response.json();
        if (result.success) {
            alert('åˆ é™¤æˆåŠŸï¼');
            loadVolunteers();
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
    }
}

// æ¸…ç©ºæ–¹æ¡ˆ
async function clearPlan() {
    if (!confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰å¿—æ„¿ï¼Ÿ')) return;

    try {
        const response = await fetch('/api/volunteer/volunteers/clear', {
            method: 'POST'
        });



        const result = await response.json();
        if (result.success) {
            alert('æ¸…ç©ºæˆåŠŸï¼');
            loadVolunteers();
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('æ¸…ç©ºå¤±è´¥ï¼š' + error.message);
    }
}

// å¯¼å‡ºæ–¹æ¡ˆ
async function exportPlan(format = 'excel') {
    try {
        const response = await fetch('/api/volunteer/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ format })
        });



        const result = await response.json();
        if (result.success) {
            alert(`å¯¼å‡ºæˆåŠŸï¼\næ–‡ä»¶ä½ç½®ï¼š${result.filepath}`);
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
    }
}

// æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
function openAddModal() {
    const modal = new bootstrap.Modal(document.getElementById('addModal'));
    modal.show();
}

// æ‰“å¼€æ‰¹é‡æ·»åŠ æ¨¡æ€æ¡†
function openBatchAddModal() {
    selectedBatchSchools.clear();
    const modal = new bootstrap.Modal(document.getElementById('batchAddModal'));
    modal.show();
}

// ä¸€é”®ç”Ÿæˆ120ä¸ªå¿—æ„¿
// è¾…åŠ©å‡½æ•°ï¼šè·å–æ¦‚ç‡å¾½ç« ç±»
function getProbabilityBadgeClass(probability) {
    if (!probability) return 'bg-secondary';
    if (probability >= 80) return 'bg-success';
    if (probability >= 60) return 'bg-warning';
    return 'bg-danger';
}

// è¾…åŠ©å‡½æ•°ï¼šè·å–é£é™©å¾½ç« ç±»
function getRiskBadgeClass(risk) {
    if (!risk) return 'bg-secondary';
    const riskMap = {
        'æä½': 'bg-success',
        'ä½': 'bg-success',
        'ä¸­': 'bg-warning',
        'ä¸­é«˜': 'bg-warning',
        'é«˜': 'bg-danger',
        'æé«˜': 'bg-danger'
    };
    return riskMap[risk] || 'bg-secondary';
}

// è¾…åŠ©å‡½æ•°ï¼šè·å–ç±»åˆ«å¾½ç« ç±»
function getCategoryBadgeClass(category) {
    if (!category) return 'bg-secondary';
    const categoryMap = {
        'å†²': 'bg-danger',
        'ç¨³': 'bg-warning',
        'ä¿': 'bg-success'
    };
    return categoryMap[category] || 'bg-secondary';
}

// æ‰“å¼€é™¢æ ¡åˆ†æé¡µé¢
function openUniversityAnalysis(schoolName, majorName = '', rank = '', event) {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘çˆ¶å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // ä¿å­˜å­¦æ ¡ä¿¡æ¯åˆ°sessionStorageï¼Œåœ¨é™¢æ ¡åˆ†æé¡µé¢ä¸­ä½¿ç”¨
    const schoolInfo = {
        schoolName: schoolName,
        majorName: majorName,
        rank: rank
    };
    sessionStorage.setItem('selectedSchoolInfo', JSON.stringify(schoolInfo));
    // ä¿å­˜å­¦æ ¡åç§°ï¼ˆå‘åå…¼å®¹ï¼‰
    sessionStorage.setItem('selectedSchool', schoolName);
    // ä½¿ç”¨æ–°çª—å£æ‰“å¼€é™¢æ ¡åˆ†æé¡µé¢
    window.open('/university', '_blank');
}


// æ›´æ–°å¯è§†åŒ–æ•°æ®
function updateVisualization() {
    loadVisualizationData();
}

// ä¸€é”®ç”Ÿæˆ120ä¸ªå¿—æ„¿
async function generateVolunteers() {
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const button = document.querySelector('button[onclick="generateVolunteers()"]');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-spinner bi-spin"></i> ç”Ÿæˆä¸­...';
        button.disabled = true;

        // æ£€æŸ¥å½“å‰æ–¹æ¡ˆæ˜¯å¦å­˜åœ¨
        const planResponse = await fetch('/api/volunteer/plan/current');
        const planResult = await planResponse.json();
        
        if (!planResult.success) {
            alert('è¯·å…ˆåˆ›å»ºæ–¹æ¡ˆï¼Œå†ç”Ÿæˆå¿—æ„¿');
            return;
        }

        // æ”¶é›†ç”¨æˆ·åå¥½è®¾ç½®
        const preferences = {
            locations: [],
            majors: [],
            school_types: [],
            gradient_ratio: {},
            min_probability: parseInt(document.getElementById('pref-min-prob').value) || 30
        };

        // æ”¶é›†åœ°åŒºåå¥½
        const selectedLocations = Array.from(document.getElementById('pref-locations').selectedOptions).map(option => option.value);
        preferences.locations = selectedLocations;

        // æ”¶é›†ä¸“ä¸šåå¥½
        const selectedMajors = Array.from(document.getElementById('pref-majors').selectedOptions).map(option => option.value);
        preferences.majors = selectedMajors;

        // æ”¶é›†å­¦æ ¡ç±»å‹åå¥½
        if (document.getElementById('pref-985').checked) preferences.school_types.push('985');
        if (document.getElementById('pref-211').checked) preferences.school_types.push('211');
        if (document.getElementById('pref-double-first').checked) preferences.school_types.push('åŒä¸€æµ');

        // æ”¶é›†å†²ç¨³ä¿æ¯”ä¾‹
        preferences.gradient_ratio = {
            'å†²': parseInt(document.getElementById('pref-chong').value) / 120,
            'ç¨³': parseInt(document.getElementById('pref-wen').value) / 120,
            'ä¿': parseInt(document.getElementById('pref-bao').value) / 120
        };

        // è·å–ç®—æ³•é€‰æ‹©
        const algorithm = document.getElementById('algorithm-select').value;
        
        // å‘é€è¯·æ±‚åˆ°åç«¯
        const response = await fetch('/api/volunteer/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                preferences,
                algorithm: algorithm  // æ·»åŠ ç®—æ³•é€‰æ‹©
            })
        });



        const result = await response.json();

        if (result.success) {
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert(result.message);
            
            // åˆ·æ–°å¿—æ„¿åˆ—è¡¨
            loadVolunteers();
            
            // åˆ·æ–°é£é™©è¯„ä¼°
            updateRiskAssessment();
            
            // åˆ·æ–°å¯è§†åŒ–åˆ†æ
            updateVisualization();
        } else {
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            alert(result.message);
        }
    } catch (error) {
        console.error('ç”Ÿæˆå¿—æ„¿å¤±è´¥ï¼š', error);
        alert('ç”Ÿæˆå¿—æ„¿å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const button = document.querySelector('button[onclick="generateVolunteers()"]');
        button.innerHTML = '<i class="bi bi-magic"></i> ä¸€é”®ç”Ÿæˆ120ä¸ªå¿—æ„¿';
        button.disabled = false;
    }
}
</script>
{% endblock %}